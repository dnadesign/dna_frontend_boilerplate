#!/usr/bin/env php
<?php

/**
 * helix (1)
 *
 * This is the command line runner for managing helix project. It allows the 
 * user to sync components, create packages and build new projects.
 *
 * For best use, this should be symlinked to your /usr/local/bin
 */

$op = null;
$updated = false;

if (isset($_SERVER['argv'][1])) {
	$op = $_SERVER['argv'][1];
}

$pwd = $_SERVER['PWD'];
$swd = dirname(dirname(realpath($_SERVER['argv'][0])));
$assets = $swd .'/build/helix/assets';

require_once $swd . '/bin/lib/Colors.php';

$setupFiles = array(
	'.bowerrc',
	'bower.json',
	'Gruntfile.js',
	'package.json',
	'Makefile'
);

$setupFolders = array(
	'build',
	'build/components',
	'images',
	'images/svg',
	'dist'
);

$bower = array(
	'jquery',
	'bootstrap',
	'radio',
	'modernizer'
);

function success($short, $desc) {
	$colors = new Colors();

	echo $colors->getColoredString($short, "black", "green");
	echo " ".$desc;
	echo "\n";
}

function failure($short, $desc) {
	$colors = new Colors();
	
	echo $colors->getColoredString($short, "white", "red");
	echo " ".$desc;
	echo "\n";
}

function warn($short, $desc) {
	$colors = new Colors();
	
	echo $colors->getColoredString($short, "black", "yellow");
	echo " ". $desc;
	echo "\n";
}

function message($msg) {
	echo $msg;
	echo "\n";
}

function recurse_copy($src,$dst) { 
    $dir = opendir($src); 

    @mkdir($dst);

    if($dir) {
    	while(false !== ($file = readdir($dir)) ) { 
        	if (( $file != '.' ) && ( $file != '..' ) && $file != '.DS_Store') { 
        	    if ( is_dir($src . '/' . $file) ) { 
        	        recurse_copy($src . '/' . $file,$dst . '/' . $file); 
        	    } 
        	    else {
        	        copy($src . '/' . $file,$dst . '/' . $file); 
        	    } 
        	} 
    	} 

    	closedir($dir); 
    }
} 

function installComponent($pwd, $swd, $name) {
	if(file_exists($pwd .'/build/components/'. $name)) {
		failure('EROR', $name . ' is already installed. Please remove first.');

		exit;
	}

	$path = $swd .'/components/' . $name;

	if(file_exists($path)) {
		recurse_copy($path, $pwd .'/build/components/'. $name);

		success('DONE', $name . ' installed');
	} else {
		warn('WRN', $name . ' cannot be found.');
		message('Updating helix..');

		updateHelix($pwd, $swd);
	}
}

function updateHelix($pwd, $swd) {
	success('UPD', "Updating $swd");

	exec("cd $swd && git pull origin helix");
}

function updateInstalledHelix($pwd, $swd) {
	recurse_copy($swd .'/build/helix', $pwd .'/build/helix/');
}

switch($op) {
	case 'setup':
		updateInstalledHelix($pwd, $swd);

		foreach($setupFiles as $file) {
			if(!file_exists($pwd .'/'. $file)) {
				success("NEW", "Writing $file");

				file_put_contents(
					$pwd .'/'. $file,
					file_get_contents($assets .'/'. $file)
				);
			} else {
				warn("WRN", "$file exists, not overriding");
			}
		}

		foreach($setupFolders as $folder) {
			success("NEW", "Creating $pwd/$folder");

			if(!file_exists($pwd.'/'.$folder)) {
				mkdir($pwd.'/'. $folder);
			}
		}

		message("Setting up NPM");
		exec("npm install --silent");

		message("Installing bower");
		exec("npm install bower -g");

		message("Setting up bower");
		exec("bower install");

		message("Setting up modernizr");
		exec("grunt modernizr");

		message("Installing bower dependancies");

		foreach($bower as $dependancy) {
			message(" - $dependancy");

			exec("bower install $dependancy");
		}

		message("Importing global");
		installComponent($pwd, $swd, 'forms');
		installComponent($pwd, $swd, 'type');
		installComponent($pwd, $swd, 'grid');
	break;
	case 'create':
		if(isset($_SERVER['argv'][2])) {
			$folder = $_SERVER['argv'][2];

			if(!file_exists($pwd.'/build/components')) {
				mkdir($pwd.'/build/components');
			}
			
			success("NEW", "Creating $pwd/build/components/$folder");
			$path = $pwd.'/build/components/'.$folder;

			if(!file_exists($path)) {
				mkdir($path);
			}

			touch($pwd.'/build/components/'.$folder.'/'.$folder.'.less');
			success("NEW", "Creating $pwd/build/components/$folder/$folder.less");
		} else {
			failure("EROR", "Please provide a component name");

			exit();
		}
	break;
	case 'remove':
		if(isset($_SERVER['argv'][2])) {
			$folder = $_SERVER['argv'][2];
			message("Removing $folder");
			$path = $pwd.'/build/components/'.$folder;

			if(file_exists($path)) {
				rmdir($path);
			}

		} else {
			failure("EROR", "Please provide a component name");

			exit();
		}
	break;
	case 'update':
		updateInstalledHelix($pwd, $swd);
		updateHelix($pwd, $swd);
	break;
	case 'list':
		// Ingore these files
		$ignore = array(".","..");

		if ($handle = opendir($swd .'/components/')) {
			while (false !== ($file = readdir($handle))) {
				if(!in_array($file, $ignore)) {	
					if(file_exists($pwd .'/build/components/'. $file)) {
						// check version 
						$installed = md5_file("$pwd/build/components/$file");
						$available = md5_file("$swd/components/$file");

						if($installed == $available) {
							success('INSTALLED', $file);
						} else {
							warn('CHANGED', $file);
						}
					} else {
						message('* '. $file);
					}
				}
			}
		}
	break;
	default: 
		message("helix [setup (-f)|create|install|remove|update|list]");
	break;
}